<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GD Ultimate Edition</title>
    <style>
        /* –∫–∞—Ä–æ—á–µ —Ç—É—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ü–≤–µ—Ç–æ–≤ —Ç–∏–ø–∞ —á—Ç–æ–±—ã –∫—Ä–∞—Å–∏–≤–æ –±—ã–ª–æ */
        :root {
            --u-cyan: #00ffcc;
            --u-purple: #4a195c;
            --bg-body: #02050a;
            --bg-card: #0b1120;
            --text-main: #ffffff;
            --text-muted: #94a3b8;
            --accent-green: #22c55e;
            --accent-blue: #3b82f6;
            --border-color: #1e293b;
            --u-yellow: #ffff00;
            --u-red: #ff1100;
        }

        body {
            margin: 0;
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Segoe UI', Tahoma, sans-serif;
            overflow-x: hidden;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            touch-action: manipulation;
            line-height: 1.5;
        }

        /* —Ñ–∏–∫—Å –Ω–∞–∂–∞—Ç–∏–π ios –∏ ipad os */
        button,
        a,
        .swatch {
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .navbar {
            background: rgba(2, 5, 10, 0.95);
            border-bottom: 1px solid var(--border-color);
            padding: 20px 0;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: 900;
            color: white;
            letter-spacing: 1px;
        }

        .logo span {
            color: var(--u-cyan);
        }

        .btn-main {
            background: linear-gradient(45deg, var(--u-cyan), #00ccff);
            color: black;
            padding: 12px 25px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 800;
            font-size: 16px;
            display: inline-block;
            box-shadow: 0 0 15px rgba(0, 255, 204, 0.2);
            transition: 0.3s;
            border: none;
            cursor: pointer;
            text-transform: uppercase;
            position: relative;
            z-index: 10;
        }

        .btn-main:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 25px var(--u-cyan);
        }

        .btn-main:active {
            transform: scale(0.95);
        }

        .hero {
            padding: 180px 0 120px;
            background: radial-gradient(circle at top center, #1a2035 0%, var(--bg-body) 70%);
            display: flex;
            align-items: center;
        }

        .hero-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 60px;
            align-items: center;
        }

        .hero h1 {
            font-size: 48px;
            line-height: 1.1;
            margin-bottom: 20px;
        }

        .hero p {
            color: var(--text-muted);
            font-size: 18px;
            margin-bottom: 30px;
            max-width: 450px;
        }

        .hero img {
            width: 100%;
            max-width: 550px;
            height: auto;
            filter: drop-shadow(0 0 20px rgba(0, 255, 204, 0.5));
        }

        @media (max-width: 768px) {
            .hero {
                padding: 120px 0 60px;
            }

            .hero-grid {
                grid-template-columns: 1fr;
                text-align: center;
                gap: 40px;
            }

            .hero p {
                margin: 0 auto 30px auto;
            }

            .hero h1 {
                font-size: 36px;
            }

            .hero img {
                max-width: 80%;
                margin: 0 auto;
            }

            .comparison-card {
                overflow-x: auto;
            }

            .comp-table th,
            .comp-table td {
                padding: 15px;
                font-size: 14px;
            }

            #cube {
                left: 10% !important;
            }

            #hud-score {
                right: 20px;
                font-size: 36px;
                top: 20px;
            }
        }

        .section-title {
            text-align: center;
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 60px;
            color: white;
        }

        .comparison-section {
            padding: 80px 0;
            background: var(--bg-body);
        }

        .comparison-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 10px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .comp-table {
            width: 100%;
            border-collapse: collapse;
        }

        .comp-table th,
        .comp-table td {
            padding: 25px 30px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .comp-table tr:last-child td {
            border-bottom: none;
        }

        .comp-table th {
            font-size: 18px;
            font-weight: 700;
            color: white;
        }

        .th-highlight {
            color: var(--accent-blue) !important;
            font-size: 20px;
        }

        .comp-table td {
            font-size: 16px;
            color: var(--text-muted);
        }

        .td-success {
            color: var(--accent-green) !important;
            font-weight: 600;
        }

        /* –ò–ì–†–û–í–´–ï –°–¢–ò–õ–ò */
        #game-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #222;
            z-index: 1000;
            display: none;
            touch-action: none;
            outline: none;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1020;
            pointer-events: auto;
        }

        .hidden {
            display: none !important;
        }

        #world-layer {
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #1a0b2e, #4a195c);
            position: relative;
            overflow: hidden;
        }

        #bg-grid {
            position: absolute;
            width: 200%;
            height: 100%;
            background-image: linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 50px 50px;
        }

        #floor {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 80px;
            background: #111;
            border-top: 4px solid var(--u-cyan);
            z-index: 1010;
        }

        #cube {
            /* –Ω—É —ç—Ç–æ —Å–∞–º –∫—É–±–∏–∫ –∫–∞—Ä–æ—á–µ */
            width: 50px;
            height: 50px;
            position: absolute;
            bottom: 80px;
            left: 15%;
            z-index: 1015;
            background-color: var(--u-yellow);
            border: 3px solid #000;
            box-sizing: border-box;
            will-change: bottom;
            transition: box-shadow 0.2s;
            /* –ü–ª–∞–≤–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ —Å–≤–µ—á–µ–Ω–∏—è */
            image-rendering: pixelated;
            /* —á—Ç–æ–±—ã –ø–∏–∫—Å–µ–ª–∏ –±—ã–ª–∏ —á–µ—Ç–∫–∏–µ */
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —á–∞—Å—Ç–∏—Ü (—Å–ª–µ–¥) —Ç–∏–ø–æ –∫—Ä–∞—Å–∏–≤–æ */
        .particle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: rgba(255, 255, 255, 0.5);
            z-index: 1014;
            /* –ß—É—Ç—å –Ω–∏–∂–µ –∫—É–±–∞ */
            pointer-events: none;
        }

        .obstacle {
            position: absolute;
            z-index: 1005;
            will-change: left;
        }

        .spike {
            width: 0;
            height: 0;
            border-left: 25px solid transparent;
            border-right: 25px solid transparent;
            border-bottom: 50px solid var(--u-red);
            bottom: 80px;
        }

        .portal {
            width: 50px;
            height: 120px;
            border: 4px solid #d0f;
            bottom: 80px;
            border-radius: 12px;
            background: rgba(200, 0, 255, 0.2);
            box-shadow: 0 0 20px #d0f;
        }

        .block {
            width: 50px;
            height: 50px;
            background: #444;
            border: 3px solid #fff;
            box-sizing: border-box;
        }

        .block-bonus {
            width: 150px;
            background: #554400;
            border: 4px solid #ffcc00;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: #ffcc00;
        }

        .block-bonus::after {
            content: "+2 PTS";
            font-size: 14px;
        }

        #hud-score {
            position: absolute;
            top: 30px;
            right: 50px;
            font-size: 48px;
            font-weight: 900;
            z-index: 1025;
            color: white;
            text-shadow: 2px 2px 4px black;
        }

        .swatch {
            width: 40px;
            height: 40px;
            border: 2px solid #fff;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .swatch.locked {
            cursor: not-allowed;
            opacity: 0.3;
            background: #333 !important;
        }

        footer {
            padding: 40px;
            text-align: center;
            border-top: 1px solid var(--border-color);
            color: var(--text-muted);
            background: var(--bg-body);
        }

        /* ‚îÄ‚îÄ THEMES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #world-layer.theme-space {
            background: linear-gradient(to bottom, #000010, #000830) !important;
        }

        #world-layer.theme-lava {
            background: linear-gradient(to bottom, #1a0000, #3d0800) !important;
        }

        #world-layer.theme-glitch {
            background: linear-gradient(to bottom, #000, #001a00) !important;
        }

        .theme-space #floor {
            background: #0a0010;
            border-top-color: #aaf !important;
        }

        .theme-lava #floor {
            background: #1a0500;
            border-top-color: #f40 !important;
        }

        .theme-glitch #floor {
            background: #000800;
            border-top-color: #0f0 !important;
        }

        #stars {
            position: absolute;
            inset: 0;
            pointer-events: none;
            display: none;
        }

        #lava-glow {
            position: absolute;
            bottom: 80px;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(to top, rgba(255, 50, 0, .35), transparent);
            pointer-events: none;
            display: none;
            animation: lavaPulse 2s ease-in-out infinite;
        }

        @keyframes lavaPulse {

            0%,
            100% {
                opacity: .6
            }

            50% {
                opacity: 1
            }
        }

        #glitch-lines {
            position: absolute;
            inset: 0;
            pointer-events: none;
            display: none;
            background: repeating-linear-gradient(to bottom, transparent 0, transparent 3px, rgba(0, 255, 0, .04) 3px, rgba(0, 255, 0, .04) 4px);
            animation: glitchShift .15s steps(1) infinite;
        }

        @keyframes glitchShift {
            0% {
                transform: translateX(0)
            }

            50% {
                transform: translateX(2px)
            }

            100% {
                transform: translateX(-1px)
            }
        }

        /* ‚îÄ‚îÄ GAME OBJECTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .coin {
            position: absolute;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: radial-gradient(circle at 35% 35%, #ffe95a, #e6a700);
            border: 3px solid #fff6;
            z-index: 1008;
            box-shadow: 0 0 8px #ffe00088;
            animation: coinSpin 1.2s linear infinite;
        }

        @keyframes coinSpin {
            to {
                transform: rotateY(360deg);
            }
        }

        .speed-arrow {
            position: absolute;
            z-index: 1008;
            width: 0;
            height: 0;
            border-top: 18px solid transparent;
            border-bottom: 18px solid transparent;
            border-left: 36px solid #ff4400;
            filter: drop-shadow(0 0 8px #f40);
        }

        .meteor {
            position: absolute;
            z-index: 1008;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: radial-gradient(circle at 70% 30%, #555, #111);
            box-shadow: inset 0 0 10px #000, 0 0 5px #ff5500;
            border: 2px solid #331100;
            animation: meteorSpin 2s linear infinite;
        }

        @keyframes meteorSpin {
            to {
                transform: rotate(360deg);
            }
        }

        /* ‚îÄ‚îÄ GHOST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #ghost-cube {
            position: absolute;
            bottom: 80px;
            left: 15%;
            width: 50px;
            height: 50px;
            border: 2px dashed rgba(0, 200, 255, .5);
            pointer-events: none;
            z-index: 1014;
            display: none;
        }

        /* ‚îÄ‚îÄ MODE SHAPES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #cube.mode-ufo {
            margin-bottom: 10px;
            border-radius: 40% 40% 10% 10%;
            box-shadow: 0 0 10px inset rgba(255, 255, 255, 0.5);
        }

        #cube.mode-ufo::after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: -18px;
            width: calc(100% + 36px);
            height: 22px;
            border-radius: 50%;
            background: linear-gradient(to bottom, #777, #333);
            border: 2px solid var(--u-cyan);
            box-shadow: 0 0 15px var(--u-cyan);
            z-index: -1;
        }

        #cube.mode-ufo::before {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 20%;
            width: 60%;
            height: 10px;
            border-radius: 50%;
            background: var(--u-cyan);
            filter: blur(4px);
            animation: saucerEngine 0.2s infinite alternate;
            z-index: -2;
        }

        @keyframes saucerEngine {
            from {
                opacity: 0.6
            }

            to {
                opacity: 1
            }
        }


        /* ‚îÄ‚îÄ HUD EXTRAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #hud-coins {
            position: absolute;
            top: 30px;
            left: 20px;
            font-size: 22px;
            font-weight: 900;
            z-index: 1025;
            color: #ffe000;
            text-shadow: 0 0 8px #ffe000;
        }

        #hud-mode {
            position: absolute;
            top: 85px;
            right: 50px;
            font-size: 14px;
            font-weight: 700;
            z-index: 1025;
            color: #aaa;
            letter-spacing: .08em;
            text-align: right;
        }

        #hud-theme {
            position: absolute;
            bottom: 15px;
            right: 20px;
            font-size: 11px;
            z-index: 1025;
            color: #555;
        }

        #shield-flash {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 1030;
            border: 4px solid #0f0;
            opacity: 0;
            transition: opacity .2s;
        }

        #shield-flash.on {
            opacity: .7;
            animation: shieldFlash .2s linear infinite;
        }

        @keyframes shieldFlash {
            0% {
                opacity: .4
            }

            50% {
                opacity: .9
            }

            100% {
                opacity: .4
            }
        }

        /* ‚îÄ‚îÄ ACHIEVEMENT POPUP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #ach-popup {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-120px);
            background: rgba(0, 0, 0, .88);
            border: 1px solid #ffe000;
            box-shadow: 0 0 20px rgba(255, 224, 0, .4);
            padding: 12px 22px;
            z-index: 1040;
            display: flex;
            gap: 12px;
            align-items: center;
            transition: transform .4s cubic-bezier(.34, 1.56, .64, 1);
            min-width: 230px;
            pointer-events: none;
        }

        #ach-popup.show {
            transform: translateX(-50%) translateY(0);
        }

        #ach-icon {
            font-size: 26px;
        }

        #ach-title {
            font-size: 13px;
            font-weight: 900;
            color: #ffe000;
            letter-spacing: .08em;
        }

        #ach-desc {
            font-size: 11px;
            color: #aaa;
            margin-top: 2px;
        }

        /* ‚îÄ‚îÄ THEME BUTTONS IN MENU ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .theme-btn {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            border: 2px solid #555;
            cursor: pointer;
            transition: border-color .2s, box-shadow .2s;
        }

        .theme-btn.active {
            border-color: #ffe000;
            box-shadow: 0 0 10px #ffe000;
        }
    </style>

</head>

<body>

    <div id="game-view" tabindex="0" style="display:block;">
        <div id="world-layer">
            <div id="bg-grid"></div>
            <!-- theme FX -->
            <canvas id="stars"></canvas>
            <div id="lava-glow"></div>
            <div id="glitch-lines"></div>
            <!-- HUD -->
            <div id="hud-score">0</div>
            <div id="hud-coins">üü° 0</div>
            <div id="hud-mode">CUBE</div>
            <div id="hud-theme">NEON</div>
            <div id="shield-flash"></div>
            <!-- ghost + cube -->
            <div id="ghost-cube"></div>
            <div id="cube"></div>
            <div id="floor"></div>
            <!-- achievement popup -->
            <div id="ach-popup">
                <div id="ach-icon">‚≠ê</div>
                <div>
                    <div id="ach-title">–ê–ß–ò–í–ö–ê</div>
                    <div id="ach-desc">...</div>
                </div>
            </div>
        </div>

        <div id="menu-screen" class="screen">
            <h1 style="font-size: 60px; margin-bottom: 20px; color:white; text-align:center; line-height:1;">
                GD<br>ULTIMATE</h1>
            <button class="btn-main" style="font-size: 30px; margin-bottom: 20px;" onclick="startGame()">–ò–ì–†–ê–¢–¨</button>
            <div style="display: flex; gap: 20px;margin-bottom:14px;">
                <button class="btn-main" style="background: var(--u-purple); color: white;"
                    onclick="openEditor()">–°–ö–ò–ù–´</button>
                <button class="btn-main" style="background: #555; color: white;"
                    onclick="window.location.href='index.html'">–í–´–ô–¢–ò</button>
            </div>
            <!-- Theme selector -->
            <div style="display:flex;gap:8px;margin-bottom:10px;align-items:center;">
                <span style="color:#888;font-size:12px;margin-right:4px;">THEME:</span>
                <div class="theme-btn active" style="background:linear-gradient(135deg,#1a0b2e,#4a195c)"
                    onclick="pickTheme(0,this)" title="Neon"></div>
                <div class="theme-btn" style="background:linear-gradient(135deg,#000010,#000830)"
                    onclick="pickTheme(1,this)" title="Space"></div>
                <div class="theme-btn" style="background:linear-gradient(135deg,#1a0000,#3d0800)"
                    onclick="pickTheme(2,this)" title="Lava"></div>
                <div class="theme-btn" style="background:linear-gradient(135deg,#000,#001a00)"
                    onclick="pickTheme(3,this)" title="Glitch"></div>
            </div>

            <div id="high-score-label" style="margin-top:10px;color:var(--u-cyan);font-weight:bold;">–†–ï–ö–û–†–î: 0</div>
            <div id="coin-label" style="color:#ffe000;font-size:12px;margin-top:4px;">üü° 0 –º–æ–Ω–µ—Ç –≤—Å–µ–≥–æ</div>
        </div>

        <div id="game-over-screen" class="screen hidden">
            <h1 style="color: var(--u-red); font-size: 50px;">GAME OVER</h1>
            <p style="font-size: 24px; color:white;">–°—á–µ—Ç: <span id="final-res">0</span></p>
            <button class="btn-main" onclick="startGame()">–ó–ê–ù–û–í–û</button>
            <button class="btn-main" style="background: #333; color: white; margin-top:10px;" onclick="showMenu()">–í
                –ú–ï–ù–Æ</button>
        </div>

        <div id="editor-screen" class="screen hidden">
            <h2 style="color:white;">–†–ï–î–ê–ö–¢–û–†</h2>
            <p style="color:#aaa; font-size:14px; margin-bottom:5px;">(–†–∏—Å—É–π –ø–∞–ª—å—Ü–µ–º –∏–ª–∏ –º—ã—à–∫–æ–π)</p>
            <canvas id="skin-tool" width="16" height="16"
                style="width: 200px; height: 200px; image-rendering: pixelated; border: 4px solid var(--u-cyan); background: #000; touch-action: none;"></canvas>
            <div id="color-palette"
                style="display:flex; gap:10px; margin: 20px 0; flex-wrap: wrap; justify-content: center;"></div>

            <div style="margin: 10px 0; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                <input type="file" id="skin-upload" accept="image/*" style="display: none;"
                    onchange="handleImageUpload(this)">
                <button class="btn-main"
                    style="font-size: 14px; padding: 8px 16px; background: var(--accent-blue); color: white;"
                    onclick="document.getElementById('skin-upload').click()">–ó–ê–ì–†–£–ó–ò–¢–¨ –§–û–¢–û</button>
                <label
                    style="color: white; font-size: 12px; display: flex; align-items: center; gap: 5px; cursor: pointer;">
                    <input type="checkbox" id="pixelate-check" checked> –ü–∏–∫—Å–µ–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å (16x16)
                </label>
            </div>
            <button class="btn-main" onclick="applySkin()">–°–û–•–†–ê–ù–ò–¢–¨</button>
            <button class="btn-main" style="background: #333; color: white; margin-top: 10px;"
                onclick="showMenu()">–û–¢–ú–ï–ù–ê</button>
        </div>
    </div>



    <script>
        /**
         * ==========================================
         * GD ULTIMATE ENGINE
         * –û–°–ù–û–í–ù–û–ô –°–ö–†–ò–ü–¢ –ò–ì–†–´ –ò –§–ò–ó–ò–ö–ò
         * ==========================================
         * 
         * –í —ç—Ç–æ–º —Å–∫—Ä–∏–ø—Ç–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤—Å—è —Ñ–∏–∑–∏–∫–∞ –∫—É–±–∞,
         * –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π, —Å—á–µ—Ç—á–∏–∫ –æ—á–∫–æ–≤, —á–∞—Å—Ç–∏—Ü,
         * —Ä–µ–∂–∏–º –ø—Ä–∏–∑—Ä–∞–∫–∞ (Ghost Mode) –∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä —Å–∫–∏–Ω–æ–≤.
         * 
         * –í—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ requestAnimationFrame –¥–ª—è 
         * –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø–ª–∞–≤–Ω–æ—Å—Ç–∏ –Ω–∞ 60 –∏ 120 FPS —ç–∫—Ä–∞–Ω–∞—Ö.
         * ==========================================
         */

        // 1. –ü–æ–ª—É—á–∞–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã DOM
        const cube = document.getElementById('cube');
        const hudScore = document.getElementById('hud-score');
        const hudCoins = document.getElementById('hud-coins');
        const hudMode = document.getElementById('hud-mode');
        const hudTheme = document.getElementById('hud-theme');
        const highScoreLabel = document.getElementById('high-score-label');
        const coinLabel = document.getElementById('coin-label');
        const skinTool = document.getElementById('skin-tool');
        const ctx = skinTool.getContext('2d');
        const worldLayer = document.getElementById('world-layer');
        const ghostEl = document.getElementById('ghost-cube');
        const shieldFlash = document.getElementById('shield-flash');

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           AUDIO ‚Äî Web Audio API (no files, synth only)
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        let audioCtx = null;
        function getAC() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            return audioCtx;
        }
        function tone(freq, type, dur, vol = 0.3, slide = 0) {
            try {
                const ac = getAC(), o = ac.createOscillator(), g = ac.createGain();
                o.connect(g); g.connect(ac.destination);
                o.type = type; o.frequency.value = freq;
                if (slide) o.frequency.linearRampToValueAtTime(slide, ac.currentTime + dur);
                g.gain.setValueAtTime(vol, ac.currentTime);
                g.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + dur);
                o.start(); o.stop(ac.currentTime + dur);
            } catch (e) { }
        }
        function noise(dur, vol = 0.3) {
            try {
                const ac = getAC(), buf = ac.createBuffer(1, ac.sampleRate * dur, ac.sampleRate);
                const d = buf.getChannelData(0);
                for (let i = 0; i < d.length; i++) d[i] = (Math.random() * 2 - 1) * (1 - i / d.length);
                const src = ac.createBufferSource(), g = ac.createGain();
                src.buffer = buf; src.connect(g); g.connect(ac.destination);
                g.gain.value = vol; src.start();
            } catch (e) { }
        }
        const snd = {
            jump: () => tone(420, 'square', .10, .18),
            death: () => { noise(.35, .4); tone(120, 'sawtooth', .3, .2, 50); },
            coin: () => { [700, 900, 1100].forEach((f, i) => setTimeout(() => tone(f, 'sine', .12, .25), i * 60)); },
            portal: () => tone(200, 'sawtooth', .3, .3, 900),
            mode: () => tone(330, 'triangle', .2, .25),
        };

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           THEMES
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        const THEMES = [
            { name: 'NEON', grid: 'rgba(255,255,255,.05)' },
            { name: 'SPACE', grid: 'rgba(100,150,255,.04)' },
            { name: 'LAVA', grid: 'rgba(255,100,0,.06)' },
            { name: 'GLITCH', grid: 'rgba(0,255,0,.05)' },
        ];
        let currentTheme = 0;
        function applyTheme(idx) {
            currentTheme = idx;
            const t = THEMES[idx];
            worldLayer.className = idx === 0 ? '' : idx === 1 ? 'theme-space' : idx === 2 ? 'theme-lava' : 'theme-glitch';
            document.getElementById('bg-grid').style.backgroundImage =
                `linear-gradient(${t.grid} 1px,transparent 1px),linear-gradient(90deg,${t.grid} 1px,transparent 1px)`;
            hudTheme.textContent = t.name;
            document.getElementById('lava-glow').style.display = idx === 2 ? 'block' : 'none';
            document.getElementById('glitch-lines').style.display = idx === 3 ? 'block' : 'none';
            const starsEl = document.getElementById('stars');
            starsEl.style.display = idx === 1 ? 'block' : 'none';
            if (idx === 1) drawStars(starsEl);
            // update active btn
            document.querySelectorAll('.theme-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
        }
        function drawStars(c) {
            c.width = window.innerWidth; c.height = window.innerHeight;
            const sc = c.getContext('2d');
            for (let i = 0; i < 120; i++) {
                const r = Math.random() * 1.5 + .3;
                sc.beginPath(); sc.arc(Math.random() * c.width, Math.random() * c.height * 0.7, r, 0, Math.PI * 2);
                sc.fillStyle = `rgba(200,220,255,${Math.random() * .8 + .2})`; sc.fill();
            }
        }
        function pickTheme(idx, btn) { applyTheme(idx); }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           GAME MODE
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        let gameMode = 'cube'; // cube | ufo
        let ufoTimer = 0; // How long till UFO funnel sequence starts

        function setMode(m) {
            gameMode = m;
            cube.className = m === 'cube' ? '' : 'mode-' + m;
            hudMode.textContent = m.toUpperCase();
            snd.mode();
            cube.style.transform = `rotate(0deg)`;
            curRotation = 0;
            if (m === 'ufo') {
                ufoTimer = 600; // time in frames before forced exit
                cube.style.height = miniMode ? '20px' : '36px';

                // Mark all normal obstacles for deletion so we don't clear the array while iterating
                obsList.forEach(o => {
                    if (o.type !== 'portal') {
                        o.el.remove();
                        o.markedForDeletion = true;
                    }
                });

                cY += 150; // Boost player up slightly when entering UFO
                velY = 0;
            } else {
                ufoTimer = 0;
                resetSize();
            }
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           ACHIEVEMENTS
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        const ACHS = [
            { id: 's50', icon: '‚≠ê', title: '50 –æ—á–∫–æ–≤!', desc: '–ü–µ—Ä–≤—ã–µ –ø–æ–ª—Å–æ—Ç–Ω–∏', check: s => s.score >= 50 },
            { id: 's100', icon: 'üí´', title: '–°–æ—Ç–∫–∞!', desc: '100 –æ—á–∫–æ–≤ –∑–∞ –∑–∞–±–µ–≥', check: s => s.score >= 100 },
            { id: 's200', icon: 'üî•', title: '–õ–µ–≥–µ–Ω–¥–∞', desc: '200 –æ—á–∫–æ–≤', check: s => s.score >= 200 },
            { id: 'port', icon: 'üåÄ', title: '–ü–æ—Ä—Ç–∞–ª—å—â–∏–∫', desc: '–ü—Ä–æ—à—ë–ª —á–µ—Ä–µ–∑ –ø–æ—Ä—Ç–∞–ª', check: s => s.portals > 0 },
            { id: 'coin1', icon: 'ü™ô', title: '–ö–æ–ª–ª–µ–∫—Ç–æ—Ä', desc: '–ü–µ—Ä–≤–∞—è –º–æ–Ω–µ—Ç–∞', check: s => s.coins > 0 },
            { id: 'coin3', icon: 'üèÜ', title: '–ë–æ–≥–∞—á', desc: '3 –º–æ–Ω–µ—Ç—ã –∑–∞ –∑–∞–±–µ–≥', check: s => s.coins >= 3 },
        ];
        let unlockedAchs = new Set(JSON.parse(localStorage.getItem('gd_achs') || '[]'));
        let achQueue = [];
        let achTimer = null;

        function checkAchs(s) {
            ACHS.forEach(a => {
                if (!unlockedAchs.has(a.id) && a.check(s)) {
                    unlockedAchs.add(a.id);
                    localStorage.setItem('gd_achs', JSON.stringify([...unlockedAchs]));
                    achQueue.push(a);
                }
            });
            if (achQueue.length && !achTimer) showAch();
        }
        function showAch() {
            if (!achQueue.length) { achTimer = null; return; }
            const a = achQueue.shift();
            document.getElementById('ach-icon').textContent = a.icon;
            document.getElementById('ach-title').textContent = a.title;
            document.getElementById('ach-desc').textContent = a.desc;
            document.getElementById('ach-popup').classList.add('show');
            snd.ach();
            achTimer = setTimeout(() => {
                document.getElementById('ach-popup').classList.remove('show');
                achTimer = setTimeout(showAch, 500);
            }, 2500);
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           GHOST SYSTEM
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        let ghostOn = false;
        let ghostFrames = [];   // recording this run
        let bestGhost = JSON.parse(localStorage.getItem('gd_ghost') || 'null');
        let ghostPlayIdx = 0;

        function toggleGhost() {
            ghostOn = !ghostOn;
            document.getElementById('ghost-btn').textContent = ghostOn ? '–í–ö–õ ‚úì' : '–í–´–ö–õ';
            document.getElementById('ghost-btn').style.background = ghostOn ? '#004' : '#333';
            ghostEl.style.display = ghostOn && bestGhost ? 'block' : 'none';
        }
        function ghostRecord(y) { ghostFrames.push(y); }
        function ghostSave() {
            if (curScore > bestScore && ghostFrames.length) {
                localStorage.setItem('gd_ghost', JSON.stringify(ghostFrames));
                bestGhost = ghostFrames;
            }
            ghostFrames = [];
        }
        function ghostTick() {
            if (!ghostOn || !bestGhost || !runGame) return;
            const y = bestGhost[ghostPlayIdx % bestGhost.length] || 0;
            ghostEl.style.bottom = (y + 80) + 'px';
            ghostEl.style.display = 'block';
            ghostPlayIdx++;
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           RUN STATE (per-game stats for achievements)
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        let runState = {};
        function resetRunState() {
            runState = {
                score: 0, coins: 0, portals: 0
            };
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           PERSISTENT DATA
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        let totalCoins = parseInt(localStorage.getItem('gd_coins') || '0');
        function saveTotalCoins(n) {
            totalCoins += n;
            localStorage.setItem('gd_coins', totalCoins);
            coinLabel.textContent = `ü™ô ${totalCoins} –º–æ–Ω–µ—Ç –≤—Å–µ–≥–æ`;
        }
        coinLabel.textContent = `ü™ô ${totalCoins} –º–æ–Ω–µ—Ç –≤—Å–µ–≥–æ`;

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           CORE GAME VARS
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        let runGame = false, miniMode = false, jumpHeld = false;
        let cY = 0, velY = 0, curScore = 0, frames = 0;
        let obsList = [], customSkin = null, rafId = null;
        let bestScore = parseInt(localStorage.getItem('ult_score')) || 0;
        let curRotation = 0, particles = [];
        let godMode = false;
        let sessionCoins = 0;
        let speedMult = 1, speedTimer = 0, spawnTimer = 0;
        const colors = [
            { hex: '#ffff00', req: 0 }, { hex: '#ffffff', req: 0 },
            { hex: '#ff0000', req: 50 }, { hex: '#00ff00', req: 100 },
            { hex: '#00ccff', req: 150 }, { hex: '#ff00ff', req: 200 },
        ];
        let penColor = '#ffff00';

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           UI HELPERS
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        function openGame() {
            document.getElementById('game-view').style.display = 'block';
            document.body.style.overflow = 'hidden';
            showMenu();
        }
        function closeGame() { showMenu(); }

        function showMenu() {
            stopLogic();
            highScoreLabel.innerText = `–†–ï–ö–û–†–î: ${bestScore}`;
            coinLabel.textContent = `ü™ô ${totalCoins} –º–æ–Ω–µ—Ç –≤—Å–µ–≥–æ`;
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById('menu-screen').classList.remove('hidden');
        }

        function stopLogic() {
            runGame = false;
            if (rafId) cancelAnimationFrame(rafId);
            obsList.forEach(o => o.el.remove());
            particles.forEach(p => p.el.remove());
            obsList = []; particles = [];
            cY = 0; velY = 0; curScore = 0; frames = 0; miniMode = false; curRotation = 0;
            hudScore.innerText = '0'; hudCoins.textContent = 'ü™ô 0';
            resetSize(); cube.style.transform = 'rotate(0deg)';
            godMode = false; speedMult = 1; spawnTimer = 0;
            cube.style.boxShadow = 'none';
            shieldFlash.classList.remove('on');
            setMode('cube');
            ghostEl.style.display = 'none'; ghostPlayIdx = 0;
            ghostSave();
            resetRunState();
        }

        function startGame() {
            stopLogic();
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            cube.style.background = customSkin ? `url(${customSkin})` : 'var(--u-yellow)';
            cube.style.backgroundSize = 'cover';
            runGame = true; sessionCoins = 0; ghostFrames = []; ghostPlayIdx = 0;
            rafId = requestAnimationFrame(gameLoop);
        }

        function resetSize() {
            const s = miniMode ? 25 : 50;
            cube.style.width = s + 'px'; cube.style.height = s + 'px';
            if (gameMode === 'ufo') cube.style.height = miniMode ? '20px' : '36px';
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           OBSTACLE SPAWNER (expanded types)
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        function spawnObs(type, x, y, cls = '') {
            const el = document.createElement('div');
            el.className = `obstacle ${type} ${cls}`;
            el.style.left = x + 'px'; el.style.bottom = y + 'px';
            worldLayer.appendChild(el);
            const w = cls === 'block-bonus' ? 150 :
                type === 'coin' ? 28 : type === 'speed-arrow' ? 36 : type === 'meteor' ? 45 : 50;
            const h = type === 'portal' ? 120 :
                type === 'coin' ? 28 : type === 'speed-arrow' ? 36 : type === 'meteor' ? 45 : 50;
            obsList.push({ el, type, x, y: y - 80, w, h, active: true, bonus: false });
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           PARTICLES
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        function spawnParticle(x, y) {
            const p = document.createElement('div');
            p.className = 'particle';
            const size = Math.random() * 6 + 4;
            p.style.width = size + 'px'; p.style.height = size + 'px';
            p.style.left = x + 'px'; p.style.bottom = y + 'px';
            worldLayer.appendChild(p);
            particles.push({ el: p, x, opacity: 1.0 });
        }
        function updateParticles(speed) {
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i]; p.x -= speed; p.opacity -= 0.05;
                if (p.opacity <= 0) { p.el.remove(); particles.splice(i, 1); }
                else { p.el.style.left = p.x + 'px'; p.el.style.opacity = p.opacity; }
            }
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           SKIN EDITOR
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        function initPalette() {
            const pal = document.getElementById('color-palette'); pal.innerHTML = '';
            colors.forEach(c => {
                const s = document.createElement('div'); s.className = 'swatch'; s.style.background = c.hex;
                if (bestScore >= c.req) s.onclick = () => { penColor = c.hex; }; else s.classList.add('locked');
                pal.appendChild(s);
            });
        }
        let isDrawing = false;
        function getPos(e) {
            const r = skinTool.getBoundingClientRect();
            let cx = e.clientX, cy = e.clientY;
            if (e.touches && e.touches.length > 0) { cx = e.touches[0].clientX; cy = e.touches[0].clientY; }
            return { x: Math.floor((cx - r.left) / (r.width / skinTool.width)), y: Math.floor((cy - r.top) / (r.height / skinTool.height)) };
        }
        function drawPixel(e) {
            if (!isDrawing) return; if (e.cancelable) e.preventDefault();
            const pos = getPos(e);
            if (pos.x >= 0 && pos.x < skinTool.width && pos.y >= 0 && pos.y < skinTool.height) { ctx.fillStyle = penColor; ctx.fillRect(pos.x, pos.y, 1, 1); }
        }
        skinTool.addEventListener('mousedown', e => { isDrawing = true; drawPixel(e); });
        window.addEventListener('mouseup', () => isDrawing = false);
        skinTool.addEventListener('mousemove', drawPixel);
        skinTool.addEventListener('touchstart', e => { isDrawing = true; drawPixel(e); }, { passive: false });
        skinTool.addEventListener('touchend', () => isDrawing = false);
        skinTool.addEventListener('touchmove', drawPixel, { passive: false });

        function handleImageUpload(input) {
            if (!input.files || !input.files[0]) return;
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    const pix = document.getElementById('pixelate-check').checked;
                    if (pix) { skinTool.width = 16; skinTool.height = 16; ctx.clearRect(0, 0, 16, 16); ctx.drawImage(img, 0, 0, 16, 16); }
                    else { skinTool.width = img.width; skinTool.height = img.height; ctx.clearRect(0, 0, img.width, img.height); ctx.drawImage(img, 0, 0); }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
        function openEditor() { document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden')); document.getElementById('editor-screen').classList.remove('hidden'); initPalette(); }
        function applySkin() { customSkin = skinTool.toDataURL(); showMenu(); }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           DEATH / WIN
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        function triggerDeath() {
            snd.death();
            if (curScore > bestScore) {
                bestScore = curScore;
                localStorage.setItem('ult_score', bestScore);
            }
            saveTotalCoins(sessionCoins);
            ghostSave();
            runGame = false;
            cancelAnimationFrame(rafId);
            document.getElementById('final-res').textContent = curScore;
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById('game-over-screen').classList.remove('hidden');
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           MAIN GAME LOOP
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        function gameLoop() {
            if (!runGame) return;
            frames++;
            const pSize = miniMode ? 25 : 50;
            const cubeScreenX = window.innerWidth * 0.15;
            const speed = (5 + curScore * 0.05) * speedMult;

            // ‚îÄ‚îÄ Mode-specific physics ‚îÄ‚îÄ
            if (gameMode === 'ufo') {
                if (jumpHeld) {
                    velY += 1.0; // strong upward thrust
                    if (frames % 5 === 0) spawnParticle(cube.offsetLeft + 10, cY + 80); // engine exhaust
                } else {
                    velY -= 0.6; // lower gravity falling
                }
                velY = Math.max(-10, Math.min(10, velY)); // clamp UFO speed
            } else {
                velY -= 0.9;
            }

            cY += velY;
            let onGround = false;
            const floorY = 0;

            if (cY <= 0) { cY = 0; velY = 0; onGround = true; }

            // ‚îÄ‚îÄ Ghost ‚îÄ‚îÄ
            ghostRecord(cY);
            ghostTick();

            // ‚îÄ‚îÄ Speed timer ‚îÄ‚îÄ
            if (speedTimer > 0) { speedTimer--; if (speedTimer === 0) speedMult = 1; }

            // ‚îÄ‚îÄ Collision with obstacles ‚îÄ‚îÄ
            const pRect = { x: cubeScreenX, y: cY, w: pSize, h: pSize };
            for (let i = obsList.length - 1; i >= 0; i--) {
                let o = obsList[i];
                if (o.markedForDeletion) {
                    obsList.splice(i, 1);
                    continue;
                }
                o.x -= speed; o.el.style.left = o.x + 'px';
                if (o.x < -200) { o.el.remove(); obsList.splice(i, 1); curScore++; hudScore.innerText = curScore; runState.score = curScore; checkAchs(runState); continue; }

                // AABB
                if (o.x < pRect.x + pRect.w && o.x + o.w > pRect.x && o.y < pRect.y + pRect.h && o.y + o.h > pRect.y) {
                    if (o.type === 'portal' && o.active) {
                        setMode(gameMode === 'cube' ? 'ufo' : 'cube');
                        o.active = false; o.el.style.opacity = 0.3;
                        snd.portal();
                        runState.portals++; checkAchs(runState);
                    } else if (o.type === 'coin') {
                        o.el.remove(); obsList.splice(i, 1);
                        sessionCoins++; runState.coins++;
                        hudCoins.textContent = `üü° ${sessionCoins}`;
                        snd.coin();
                        checkAchs(runState);
                    } else if (o.type === 'speed-arrow') {
                        if (o.active) { speedMult = 1.3; speedTimer = 120; o.active = false; o.el.style.opacity = .3; }
                    } else if (o.type === 'spike' || o.type === 'meteor') {
                        // Very forgiving hitbox for spikes/meteors (matches original GD feel)
                        const pad = 16;
                        if (pRect.x + pRect.w > o.x + pad && pRect.x < o.x + o.w - pad && pRect.y < o.y + o.h - pad) {
                            if (!godMode) { triggerDeath(); return; }
                        }
                    } else if (o.type.includes('block')) {
                        const isSafe = o.type.includes('safe-block');

                        // Calculate centers
                        const pCx = pRect.x + pRect.w / 2;
                        const pCy = pRect.y + pRect.h / 2;
                        const oCx = o.x + o.w / 2;
                        const oCy = o.y + o.h / 2;

                        // Calculate half-widths and half-heights
                        const pHalfW = pRect.w / 2;
                        const pHalfH = pRect.h / 2;
                        const oHalfW = o.w / 2;
                        const oHalfH = o.h / 2;

                        // Calculate distance between centers
                        const dx = pCx - oCx;
                        const dy = pCy - oCy;

                        // Calculate overlaps
                        const overlapX = pHalfW + oHalfW - Math.abs(dx);
                        const overlapY = pHalfH + oHalfH - Math.abs(dy);

                        if (overlapX > 0 && overlapY > 0) {
                            // Collision detected. Determine axis of least penetration
                            if (overlapX >= overlapY) {
                                // Vertical collision
                                if (dy > 0) {
                                    // Hit top of block (landing)
                                    cY = o.y + o.h; velY = 0; onGround = true;
                                    if (o.el.classList.contains('block-bonus') && !o.bonus) { curScore += 2; o.bonus = true; hudScore.innerText = curScore; o.el.style.background = '#00aa00'; }
                                } else {
                                    // Hit bottom of block (bumping head)
                                    if (isSafe && velY > 0) velY = 0;
                                    else if (!isSafe && !godMode) { triggerDeath(); return; }
                                }
                            } else {
                                // Horizontal collision (hitting the side)
                                // Add a tiny 2px forgiveness padding so sliding perfectly over mathematical seams doesn't trigger side hits
                                if (overlapY > 2 && !isSafe && !godMode) {
                                    triggerDeath(); return;
                                }
                            }
                        }
                    }
                }
            }

            // ‚îÄ‚îÄ Rotation ‚îÄ‚îÄ
            if (gameMode === 'ufo') {
                curRotation = 0; // saucer doesn't flip
            } else {
                if (onGround) {
                    if (jumpHeld) velY = (miniMode ? 15 : 18);
                    const snap = Math.round(curRotation / 90) * 90;
                    curRotation += ((snap - curRotation) * 0.2);
                    if (frames % 2 === 0) { spawnParticle(cube.offsetLeft, cY + 80); spawnParticle(cube.offsetLeft + (Math.random() * 20 - 10), cY + 80 + (Math.random() * 10 - 5)); }
                } else {
                    curRotation += 6;
                }
            }
            cube.style.transform = `rotate(${curRotation}deg)`;
            updateParticles(speed);
            cube.style.bottom = (cY + 80) + 'px';

            // ‚îÄ‚îÄ UFO Timer & Funnel ‚îÄ‚îÄ
            if (gameMode === 'ufo' && ufoTimer > 0) {
                ufoTimer--;
                if (ufoTimer === 0) {
                    // Create a giant "laser beam" portal instead of a funnel
                    const px = window.innerWidth + 100;

                    // A single massive portal covering the whole screen
                    // We can spawn multiple portals stacked vertically so its hitbox covers everything seamlessly
                    for (let i = 0; i < 15; i++) {
                        spawnObs('portal', px, i * 60);
                    }

                    spawnTimer = 200; // Pause normal spawns while the laser passes
                }
            }

            // ‚îÄ‚îÄ Spawn obstacles ‚îÄ‚îÄ
            spawnTimer--;
            if (spawnTimer <= 0) {
                const x = window.innerWidth + 100;

                if (gameMode === 'ufo') {
                    if (ufoTimer > 0) { // Only spawn meteors if not in funnel sequence
                        // Spread meteors across the whole vertical play area
                        const heights = [60, 120, 180, 240, 300, 360, 420, 480, 540];
                        const h1 = heights[Math.floor(Math.random() * heights.length)];
                        spawnObs('meteor', x, h1);
                        if (Math.random() > 0.4) {
                            const h2 = heights[Math.floor(Math.random() * heights.length)];
                            if (Math.abs(h1 - h2) > 100) spawnObs('meteor', x + 60, h2);
                        }
                        spawnTimer = 45; // Frequent meteors
                    }
                } else {
                    const r = Math.random();
                    if (r < 0.1) {
                        // Enter UFO portal
                        spawnObs('portal', x, 120);
                        spawnTimer = 100;
                    } else if (r < 0.25) {
                        // Solid wide block platform
                        spawnObs('block', x, 80);
                        spawnObs('block', x + 50, 80);
                        spawnTimer = 90;
                    } else if (r < 0.40) {
                        // Jump over spike onto block
                        spawnObs('spike', x, 80);
                        spawnObs('block', x + 50, 80);
                        spawnTimer = 85;
                    } else if (r < 0.50) {
                        // Speed arrow challenge
                        spawnObs('speed-arrow', x, 97);
                        spawnObs('spike', x + 120, 80);
                        spawnTimer = 90;
                    } else if (r < 0.70) {
                        // Double spike - Widen from 40 to 50 for easier clearing
                        spawnObs('spike', x, 80);
                        spawnObs('spike', x + 50, 80);
                        spawnTimer = 85;
                    } else if (r < 0.82) {
                        // High block (flying platform)
                        spawnObs('block', x, 140);
                        spawnTimer = 65;
                    } else if (r < 0.90) {
                        // Bonus block platform
                        spawnObs('block block-bonus', x, 150);
                        spawnTimer = 75;
                    } else if (r < 0.97) {
                        // Simple block
                        spawnObs('block', x, 80);
                        spawnTimer = 65;
                    } else {
                        // Single spike
                        spawnObs('spike', x, 80);
                        spawnTimer = 65;
                    }
                }
            }

            rafId = requestAnimationFrame(gameLoop);
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           INPUT
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        function doJump() {
            if (!runGame) return;
        }
        const startJump = e => {
            if (e.type === 'keydown' && e.code !== 'Space' && e.code !== 'ArrowUp') return;
            if (e.type === 'keydown' && e.repeat) return;
            if (e.cancelable) e.preventDefault();
            jumpHeld = true;
            if (gameMode !== 'ufo') {
                doJump();
                snd.jump();
            } else {
                // simple blip for UFO thruster activation
                if (frames % 10 === 0) snd.jump();
            }
        };
        const endJump = e => {
            jumpHeld = false;
        };
        window.addEventListener('keydown', startJump);
        window.addEventListener('keyup', endJump);
        window.addEventListener('mousedown', startJump);
        window.addEventListener('mouseup', () => { jumpHeld = false; shipThrust = false; });
        window.addEventListener('touchstart', startJump, { passive: false });
        window.addEventListener('touchend', endJump, { passive: false });

        // Init theme
        applyTheme(0);
    </script>

</body>

</html>